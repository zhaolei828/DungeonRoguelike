# SPD素材导入完整流程

## 🎯 重要说明

### 场景问题
所有素材准备工作**不需要任何场景**！
- ✅ 切割Sprite - Editor工具，任何时候都可以运行
- ✅ 创建Palette - Editor工具，任何时候都可以运行
- ✅ 配置LevelRenderer - 在Hierarchy中配置GameObject
- 🎮 测试效果 - 在 `TestDungeon.unity` 场景中Play

### 可以重复执行吗？
**完全可以！**所有工具都支持多次执行：
- ✅ Auto Slice Sprites - 可以重复运行，Unity会覆盖之前的切割
- ✅ Create Tile Palettes - 可以重复运行，会重新创建Tile Assets
- ✅ 配置LevelRenderer - 随时可以修改Tile引用

---

## 📋 完整操作流程

### 第0步：确认素材已复制（已完成）✅

素材位置：
```
Assets/_Project/Art/Tiles/Environment/
├── tiles_sewers.png
├── tiles_prison.png
├── tiles_caves.png
├── tiles_city.png
├── tiles_halls.png
├── terrain_features.png
└── Water/
    ├── water0.png
    ├── water1.png
    ├── water2.png
    ├── water3.png
    └── water4.png
```

**如何检查**：在Unity Project窗口导航到上述路径，确认文件存在。

---

### 第1步：切割Sprite（1-2分钟）

#### 操作步骤：

1. **打开工具窗口**
   - Unity顶部菜单：`DungeonRoguelike > SPD Tools > Auto Slice Sprites`
   - 会弹出一个工具窗口

2. **点击切割按钮**
   - 点击窗口中的 **"切割所有地形Tile (16x16)"** 大按钮
   - 等待进度条（如果有）

3. **查看结果**
   - 会弹出对话框显示：`✅ 成功切割: 6/6` （或类似信息）
   - 点击 **"确定"**

4. **验证切割结果（可选）**
   
   **方法1：查看Console**
   - 点击工具窗口中的 **"打开Console查看详细日志"** 按钮
   - 或 Unity顶部菜单：`Window > General > Console`
   - 你会看到类似的日志：
     ```
     ✓ 切割成功: tiles_sewers.png
     ✓ 切割成功: tiles_prison.png
     ✓ 切割成功: tiles_caves.png
     ✓ 切割成功: tiles_city.png
     ✓ 切割成功: tiles_halls.png
     ✓ 切割成功: terrain_features.png
     ```
   
   **方法2：查看Sprite**
   - 在Project窗口选择任意PNG（如 `tiles_sewers.png`）
   - 点击左侧的小三角 ▶ 展开
   - 你会看到很多子Sprite（如 `tiles_sewers_0_0`, `tiles_sewers_0_1` 等）
   - 这就说明切割成功了！

#### 常见问题：

**Q: 弹出对话框说 "失败: 6"**
- 检查PNG文件是否在正确位置
- 选择PNG，在Inspector中确认 `Texture Type` 是 `Sprite (2D and UI)`

**Q: Console有很多警告**
- 忽略关于LF/CRLF的警告（这是Git换行符问题，不影响功能）

**Q: 可以重复运行吗？**
- 完全可以！Unity会自动覆盖之前的切割结果

---

### 第2步：创建Tile Palette（1-2分钟）

#### 操作步骤：

1. **打开工具窗口**
   - Unity顶部菜单：`DungeonRoguelike > SPD Tools > Create Tile Palettes`
   - 会弹出一个工具窗口

2. **点击创建按钮**
   - 点击窗口中的 **"🎨 创建所有Tile Palette"** 大按钮
   - 等待处理（可能需要1-2分钟，因为要创建约840个Tile Assets）

3. **查看结果**
   - 会弹出对话框显示：
     ```
     成功创建 6/6 个Tile Palette！
     
     查看位置: Assets/_Project/Art/Tiles/Palettes/
     ```
   - 点击 **"确定"**

4. **验证创建结果**
   
   **方法1：查看Palette文件**
   - 在Project窗口导航到：`Assets/_Project/Art/Tiles/Palettes/`
   - 你会看到6个Prefab文件：
     - SewersTilePalette
     - PrisonTilePalette
     - CavesTilePalette
     - CityTilePalette
     - HallsTilePalette
     - FeaturesTilePalette
   
   **方法2：查看Tile Assets**
   - 在Project窗口导航到：`Assets/_Project/Art/Tiles/TileAssets/`
   - 你会看到6个子文件夹，每个包含很多 `.asset` 文件
   - 这些就是Tile Assets！

   **方法3：查看Console**
   - Console会显示详细的创建日志

#### 常见问题：

**Q: 报错 "贴图未切割"**
- 先运行第1步的 `Auto Slice Sprites`

**Q: 创建很慢**
- 正常！840个Tile Assets需要时间，耐心等待

**Q: 可以重复运行吗？**
- 可以！会覆盖之前创建的Tile Assets和Palette

---

### 第3步：配置LevelRenderer（5分钟）

#### 操作步骤：

1. **打开TestDungeon场景**
   - 在Project窗口导航到：`Assets/_Project/Scenes/TestDungeon.unity/`
   - 双击 `TestDungeon.unity` 打开场景

2. **找到LevelRenderer GameObject**
   - 在Hierarchy窗口查找 `LevelRendererObject`
   - 或者直接搜索 `LevelRenderer`
   - 选择它

3. **查看Inspector面板**
   - 确保有 `LevelRenderer` 组件
   - 展开 **"Tile资源"** 部分
   - 你会看到很多空的字段：
     ```
     Floor Tile: None
     Wall Tile: None
     Water Tile: None
     ...
     ```

4. **分配Tile（快速方法）**
   
   **最简单：只配置Floor和Wall**
   
   a. 在Project窗口导航到：
      ```
      Assets/_Project/Art/Tiles/TileAssets/SewersTilePalette/
      ```
   
   b. 随便选一个Tile（比如 `tiles_sewers_0_0`）
      - 拖到Inspector的 `Floor Tile` 字段
   
   c. 再选一个**不同**的Tile（比如 `tiles_sewers_4_0`，通常是墙壁）
      - 拖到Inspector的 `Wall Tile` 字段
   
   d. 完成！至少地板和墙壁会有不同颜色了

5. **分配更多Tile（可选）**
   
   如果想要更完整的效果，可以继续配置：
   
   - **Water Tile**: 
     - 导航到 `Assets/_Project/Art/Tiles/Environment/Water/`
     - 选择 `water0.png` 下的Sprite（不是PNG本身）
     - 拖到 `Water Tile` 字段
   
   - **Grass Tile**: 
     - 从 `FeaturesTilePalette` 文件夹找草地图案的Tile
   
   - **Door Tile**: 
     - 从 `FeaturesTilePalette` 文件夹找门图案的Tile
   
   - **Entrance/Exit Tile**: 
     - 从 `FeaturesTilePalette` 文件夹找楼梯图案的Tile

#### 如何识别Tile是什么？

**方法1：预览**
- 在Project窗口选择Tile Asset
- 看Inspector下方的预览图

**方法2：名称**
- Tile命名规则：`tiles_sewers_Y_X`
  - Y = 行号（第几行）
  - X = 列号（第几列）
- 通常：
  - 第0-1行：地板类
  - 第4-5行：墙壁类
  - 第2-3行：水、草类

**方法3：查看原图**
- 在Project窗口双击PNG文件（如 `tiles_sewers.png`）
- 会打开Sprite Editor，可以看到所有Tile的布局

---

### 第4步：测试效果（1分钟）

#### 操作步骤：

1. **确认在TestDungeon场景**
   - 场景名称应该显示在Hierarchy窗口顶部

2. **点击Play按钮** ▶️
   - Unity顶部中间的三角形播放按钮
   - 进入Play模式

3. **按G键生成地牢**
   - 在Game视图中按键盘 `G` 键
   - 地牢会重新生成

4. **查看效果**
   - 你应该能看到：
     - ✅ 不再是空白的黑屏
     - ✅ 有不同颜色/图案的地板和墙壁
     - ✅ 真实的SPD像素艺术！

5. **反复测试**
   - 可以多次按G键，每次生成不同的地牢
   - 如果还是空白或报错，查看Console窗口

6. **退出Play模式**
   - 再次点击Play按钮或按 `Ctrl+P` / `Cmd+P`

---

## 🔍 如何查看执行结果

### Console窗口（最详细）

打开方式：
- Unity顶部菜单：`Window > General > Console`
- 快捷键：`Ctrl+Shift+C` (Windows) 或 `Cmd+Shift+C` (Mac)

你会看到：
```
=== 开始自动化测试地牢生成 ===
[SPD导入] 已配置: tiles_sewers.png
[SPD导入] 已配置: tiles_prison.png
...
✓ 切割成功: tiles_sewers.png
✓ 切割成功: tiles_prison.png
...
--- 创建 SewersTilePalette ---
找到 224 个Sprite
✓ 创建了 224 个新Tile Assets
✓ Palette已创建: Assets/_Project/Art/Tiles/Palettes/SewersTilePalette.prefab
...
```

### 工具窗口（快速查看）

- 在 `Auto Slice Sprites` 窗口中会显示：
  ```
  ✅ 切割完成！
  成功: 6/6
  失败: 0
  ```

- 在 `Create Tile Palettes` 窗口中会显示成功数量

### 弹出对话框（最直观）

每个工具执行完都会弹出一个对话框显示结果。

---

## ⚠️ 常见问题排查

### 问题1：工具菜单看不到
**症状**：Unity顶部没有 `DungeonRoguelike` 菜单

**解决**：
1. 等待Unity编译完成（查看右下角状态栏）
2. 如果还是没有，重启Unity编辑器

---

### 问题2：切割失败
**症状**：对话框显示 "失败: 6"

**解决**：
1. 检查PNG文件是否存在：
   ```
   Assets/_Project/Art/Tiles/Environment/tiles_sewers.png
   ```
2. 选择PNG，在Inspector中确认：
   - `Texture Type`: Sprite (2D and UI)
   - `Sprite Mode`: Multiple

---

### 问题3：创建Palette失败
**症状**：对话框显示 "成功创建 0/6"

**解决**：
1. 先运行 `Auto Slice Sprites`
2. 检查Console的错误信息
3. 确认Sprite已切割（PNG下有子Sprite）

---

### 问题4：Play后还是空白
**症状**：按G键后Game视图还是黑屏

**解决**：
1. 检查LevelRenderer是否配置了 `Floor Tile` 和 `Wall Tile`
2. 检查Console是否有错误
3. 确认在TestDungeon场景中
4. 确认Tilemap已自动找到（Console应该有 "自动找到GroundTilemap" 日志）

---

### 问题5：地图显示但都是同一个颜色
**症状**：地图有了，但地板和墙壁看起来一样

**解决**：
- Floor Tile 和 Wall Tile 使用了同一个Tile
- 重新分配不同的Tile

---

## 📊 预期结果统计

完成所有步骤后：

```
✅ 切割的Sprite数量：约840个
✅ 创建的Tile Assets：约840个
✅ 创建的Palette：6个
✅ 配置的LevelRenderer字段：至少2个（Floor和Wall）
✅ 地牢效果：可见的SPD像素艺术
```

---

## 🎯 下一步

完成素材导入后，你可以：

1. **继续Week 5** - 玩家系统开发
2. **优化Tile配置** - 配置更多的地形类型
3. **创建水动画** - 让水流动起来
4. **导入角色Sprite** - 为Week 5做准备

---

**文档版本**: v1.1  
**最后更新**: 2025-10-17  
**状态**: 🟢 已测试，可直接使用

🎨 按照这个流程操作，绝对没问题！

# 第5阶段: Hero动画系统验证

## 问题背景

在Week 5实现的Hero运动系统中，发现Hero移动动画看起来"奇怪"，像"多张图在切换一样"。经过分析，这是因为原本的动画加载和播放逻辑存在以下问题：

### 原问题

1. **无法正确识别animator加载的sprites** - HeroAnimator尝试从Resources加载，但warrior.png可能不在Resources文件夹中
2. **Sprite命名理解有误** - warrior.png使用的是`warrior_X_Y`格式（X=动作类型，Y=帧序列），不是简单的idle/walk_down等关键词
3. **动画帧率和运动速度不匹配** - 需要确保动画帧率与Hero.moveDuration一致

## 修复方案

### 1. 正确理解warrior.png的sprite结构

warrior.png中有68个sprites，组织如下：
- `warrior_0_0` ~ `warrior_0_20` (21帧) = 动作0 (Idle)
- `warrior_1_0` ~ `warrior_1_20` (21帧) = 动作1 (WalkDown)
- `warrior_2_0` ~ `warrior_2_20` (21帧) = 动作2 (WalkUp)
- `warrior_3_0` ~ `warrior_3_20` (21帧) = 动作3 (WalkLeft)
- `warrior_4_0` ~ `warrior_4_20` (21帧) = 动作4 (WalkRight)
- `warrior_5_0` ~ `warrior_5_20` (21帧) = 动作5 (Attack)
- `warrior_6_0` ~ `warrior_6_20` (21帧) = 动作6 (Death)

### 2. 改进的LoadWarriorSprites实现

```csharp
public void LoadWarriorSprites()
{
    // 从AssetDatabase加载（在编辑器模式下）
    Sprite[] allSprites = Resources.LoadAll<Sprite>("Characters/warrior");
    
    if (allSprites == null || allSprites.Length == 0)
    {
        // 尝试从AssetDatabase加载
        allSprites = LoadSpritesFromAssetDatabase();
    }
    
    // 按warrior_X_Y格式解析并分类
    AssignSpritesToAnimations(allSprites);
}

private void AssignSpritesToAnimations(Sprite[] allSprites)
{
    // 创建字典按动作编号分组
    var actionSprites = new Dictionary<int, List<Sprite>>();
    
    foreach (Sprite sprite in allSprites)
    {
        // 匹配 warrior_X_Y 格式
        var match = Regex.Match(sprite.name, @"warrior_(\d+)_(\d+)");
        if (match.Success)
        {
            int actionType = int.Parse(match.Groups[1].Value);
            actionSprites[actionType].Add(sprite);
        }
    }
    
    // 按SPD约定分配
    idleSprites = SortAndReturnSprites(actionSprites, 0);
    walkDownSprites = SortAndReturnSprites(actionSprites, 1);
    walkUpSprites = SortAndReturnSprites(actionSprites, 2);
    walkLeftSprites = SortAndReturnSprites(actionSprites, 3);
    walkRightSprites = SortAndReturnSprites(actionSprites, 4);
}

private Sprite[] SortAndReturnSprites(Dictionary<int, List<Sprite>> actionSprites, int actionType)
{
    // 按帧序列号排序
    var sorted = actionSprites[actionType]
        .OrderBy(s => int.Parse(Regex.Match(s.name, @"warrior_\d+_(\d+)").Groups[1].Value))
        .ToArray();
    return sorted;
}
```

### 3. 自动初始化机制

在HeroAnimator.Start()中自动调用LoadWarriorSprites()：

```csharp
private void Start()
{
    // 如果尚未加载sprites，自动加载
    if ((idleSprites == null || idleSprites.Length == 0) &&
        (walkDownSprites == null || walkDownSprites.Length == 0))
    {
        LoadWarriorSprites();
    }
}
```

## 测试步骤

1. 打开Game.unity场景
2. 进入Play模式
3. Hero应该自动生成并显示idle动画
4. 按WASD移动Hero，观察对应方向的行走动画
5. 查看Console日志确认sprites已正确加载

## 预期结果

```
✓ 加载了 68 个warrior sprite
✓ 从AssetDatabase加载 68 个sprites
✓ 动画帧分配完成:
  Idle: 21 frames
  WalkDown: 21 frames
  WalkUp: 21 frames
  WalkLeft: 21 frames
  WalkRight: 21 frames
```

## 调试工具

已创建编辑器工具 `TestHeroAnimationLoading.cs`，可通过菜单 **Tools > Test > Load Game Scene and Test Hero Animation** 快速测试Hero动画加载。

